name: CI Workflow

on:
  push:
    branches: [main]

  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  build:
    runs-on: windows-latest

    env:
      # Set environment variables globally for the job
      PowerQuerySDKPath: ${{ github.workspace }}/_temp/

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v2

      # Install NuGet
      - name: Install NuGet
        run: |
          choco install nuget.commandline

      # Install PowerQuery SDK in the specified PowerQuerySDKPath
      - name: Install PowerQuery SDK
        run: |
          # Install PowerQuery SDK (NuGet install) in the PowerQuerySDKPath
          nuget install Microsoft.PowerQuery.SdkTools -Version 2.144.1 -OutputDirectory $env:PowerQuerySDKPath -ExcludeVersion

      - name: List contents of PowerQuerySDKPath
        shell: pwsh
        run: |
          Write-Host "Listing contents of: $env:PowerQuerySDKPath"
          Get-ChildItem -Path $env:PowerQuerySDKPath

      # Check if the Exasol.mproj file exists before running MakePqx
      - name: Compile step/ Create .mez file
        run: |
          
          # Ensure correct path to MakePqx
          $makePqxPath = Join-Path $env:PowerQuerySDKPath "Microsoft.PowerQuery.SdkTools\tools\MakePqx.exe compile"
          
          # Navigate to the Exasol directory
          cd "$env:GITHUB_WORKSPACE\Exasol"
          # Run MakePqx to create the .mez file
          & $makePqxPath

      # Modify RunPQSDKTestSuitesSettings.json file
      - name: Modify RunPQSDKTestSuitesSettings.json file
        run: |
          $filePath = "$env:GITHUB_WORKSPACE\tests\RunPQSDKTestSuitesSettings.json"
          $jsonContent = Get-Content $filePath | ConvertFrom-Json

          # Modify the JSON content
          $jsonContent.PQTestExePath = "$env:PowerQuerySDKPath\Microsoft.PowerQuery.SdkTools\tools\PQTest.exe"

          # Correct the path to the .mez file (one level back from /tests/)
          $jsonContent.ExtensionPath = "$env:GITHUB_WORKSPACE\Exasol\bin\AnyCPU\Debug\Exasol.mez"

          # Write the modified content back to the file
          $jsonContent | ConvertTo-Json -Compress | Set-Content $filePath

      # Replace placeholders in credentials.json with GitHub secrets
      - name: Replace placeholders in credentials.json
        run: |
          $filePath = "$env:GITHUB_WORKSPACE\tests\credentials.json"
          $jsonContent = Get-Content $filePath | ConvertFrom-Json

          # Replace placeholders with GitHub secrets
          $jsonContent.AuthenticationProperties.Username = "${{ secrets.pbi_username }}"
          $jsonContent.AuthenticationProperties.Password = "${{ secrets.pbi_password }}"

          # Write the modified content back to the file
          $jsonContent | ConvertTo-Json -Compress | Set-Content $filePath

      # Run the PowerShell script with the -DetailedResults flag
      - name: Run PowerShell Test Suite
        run: |
          # Navigate to the tests folder
          cd "$env:GITHUB_WORKSPACE\tests"

          # Run the PowerShell script with the -DetailedResults flag
          .\RunPQSDKTestSuites.ps1 -DetailedResults
